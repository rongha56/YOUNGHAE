<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="qnaMapper">

 	<resultMap type="Member" id="member">
  		<id column="USER_NUM" property="userNum"/>
  		<result column="USER_ID" property="userId"/>
  		<result column="USER_NAME" property="userName"/>
  		<result column="USER_NICKNAME" property="userNickname"/>
  		<result column="USER_EMAIL" property="email"/>
  		<result column="USER_GENDER" property="gender"/>
  		<result column="USER_BIRTH" property="userBirth"/>
  		<result column="USER_PHONE" property="userPhone"/>
  		<result column="USER_RECOMMEND" property="userRecommend"/>
  		<result column="USER_ENROLLDATE" property="userEnrollDate"/>
  		<result column="USER_CNUMBER" property="userCNumber"/>
  		<result column="USER_STATUS" property="userStatus"/>
  		<result column="USER_MODIFYDATE" property="userModifyDate"/>
  	</resultMap>

  	<resultMap type="Board" id="board">
  		<id column="BOARD_NUM" property="boardNum"/>
  		<result column="BOARD_TITLE" property="boardTitle"/>
  		<result column="BOARD_CONTENT" property="boardContent"/>
  		<result column="BOARD_CREATEDATE" property="boardCreateDate"/>
  		<result column="BOARD_MODIFYDATE" property="boardModifyDate"/>
  		<result column="BOARD_VIEW" property="boardView"/>
  		<result column="BOARD_STATUS" property="boardStatus"/>
  		<result column="USER_NUM" property="userNum"/>
  		<result column="BOARD_TYPE" property="boardType"/>
  	</resultMap>

	<resultMap type="SupplementRespDto" id="supplementResp">
  		<id column="PRO_NUM" property="proNum"/>
  		<result column="PRO_IMAGE" property="proImage"/>
  		<result column="PRO_NAME" property="proName"/>
  		<result column="PRO_COMPANY" property="proCompany"/>
  		<result column="PRO_EFFECT" property="proEffect"/>
  		<result column="CATE_NAME" property="cateName"/>
	</resultMap>
	
	<select id="login" resultMap="member">
		select * from member
		where user_num=#{userNum}
	</select>
	
	<select id="getListCount" resultType="_int">
		SELECT COUNT(*) FROM QUESTION
	</select>
<!--   sd -->
<!-- 
	<select id="selectQuestionList" resultMap="questionResp">
		SELECT Q.QUESTION_NUM BOARD_NUM,
	            BOARD_TITLE,
	            BOARD_CREATEDATE, 
	            BOARD_VIEW, 
	            USER_NUM,
	            IS_SOLVED,
	            COUNT(ANSWER_NUM) ANSWERCOUNT
		FROM QUESTION Q
		    JOIN BOARD ON (Q.QUESTION_NUM = BOARD_NUM)
		    JOIN ANSWER ON (Q.QUESTION_NUM = ANSWER.QUESTION_NUM)
		WHERE BOARD_STATUS = 'Y'
		GROUP BY Q.QUESTION_NUM, BOARD_TITLE, BOARD_CREATEDATE, BOARD_VIEW, USER_NUM, IS_SOLVED
		ORDER BY Q.QUESTION_NUM DESC
	</select>
-->
	<select id="getMyQuestionCount" resultType="_int">
		SELECT COUNT(*)
		FROM BOARD
		WHERE BOARD_STATUS='Y' AND USER_NUM =#{userNum} AND BOARD_TYPE = '5'
	</select>
	
	<select id="getIsRead" resultType="_int">
		SELECT COUNT(*)
		FROM BOARD
		    JOIN QUESTION ON (BOARD_NUM = QUESTION_NUM)
		WHERE IS_READ = 'N' AND BOARD_STATUS='Y' AND USER_NUM =#{userNum} AND BOARD_TYPE = '5'
	</select>

	<select id="searchSupplement" resultMap="supplementResp">
		SELECT PRO_NUM, PRO_IMAGE, PRO_NAME, PRO_COMPANY, PRO_EFFECT, CATE_NAME
		FROM PRODUCT
		JOIN CATEGORY USING (CATE_NUM)
		WHERE PRO_NAME LIKE '%#{keyword}%'
	</select>

	<insert id="insertQuestion">
		INSERT ALL 
			INTO BOARD VALUES(SEQ_BOARD.NEXTVAL, #{boardTitle}, #{boardContent}, DEFAULT, DEFAULT, DEFAULT, DEFAULT, #{userNum}, 5)
			INTO QUESTION VALUES(SEQ_BOARD.CURRVAL, 
				<if test="supplement != null &amp;&amp; !supplement.equals('')">
					#{supplement}, 
				</if>
				<if test="supplement == null or supplement.equals('')">
					NULL,
				</if>
			DEFAULT, DEFAULT)
			<if test="attachParam != null">
				INTO ATTACHMENT VALUES (SEQ_ATTACH.NEXTVAL, DEFAULT, #{attachParam.attachName}, #{attachParam.attachRename}, #{attachParam.attachPath}, 5, SEQ_BOARD.CURRVAL, DEFAULT)
			</if>
		SELECT * FROM DUAL
	</insert>
	
	<select id="selectBoardList" resultMap="board">
		SELECT * FROM BOARD WHERE BOARD_TYPE = '5' AND BOARD_STATUS = 'Y' ORDER BY BOARD_NUM DESC
	</select>
	
	<select id="selectWriterInfo" resultType="map">SELECT USER_GENDER, USER_BIRTH FROM MEMBER WHERE USER_NUM = #{userNum}</select>
	<select id="selectAnswerCount" resultType="_int">SELECT COUNT(*) FROM ANSWER WHERE QUESTION_NUM = #{boardNum}</select>
	<select id="getIsSolved" resultType="string">SELECT IS_SOLVED FROM QUESTION WHERE QUESTION_NUM = #{boardNum}</select>
	
	<select id="getTopTwo" resultMap="board">
		SELECT * FROM 
		(
			SELECT * FROM BOARD 
			WHERE BOARD_TYPE = '5' AND BOARD_STATUS = 'Y' 
			ORDER BY BOARD_VIEW DESC
		) 
		<![CDATA[WHERE ROWNUM <=2]]>
	</select>
	
	<select id="selectQuestion" resultMap="board">SELECT * FROM BOARD WHERE BOARD_NUM = #{boardNum}</select>
	<update id="addViewCount">UPDATE BOARD SET BOARD_VIEW = BOARD_VIEW + 1 WHERE BOARD_NUM = #{boardNum} </update>
	<update id="updateIsRead">UPDATE QUESTION SET IS_READ = 'Y' WHERE QUESTION_NUM = #{boardNum} </update>
	
	<select id="selectSupplement" resultMap="supplementResp">
		SELECT * 
		FROM PRODUCT 
		WHERE PRO_NUM = (SELECT PRO_NUM FROM QUESTION WHERE QUESTION_NUM = #{boardNum})
	</select>
	
</mapper>
